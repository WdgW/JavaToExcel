name: Java to Excel Conversion

on:
  push:
    
  workflow_dispatch:
    inputs:
      input_folder:
        description: 'Path to folder containing Java files (relative to workspace)'
        required: true
        default: 'Mindustry/core/src/mindustry/'
      output_folder:
        description: 'Output root directory (will mirror input folder structure)'
        required: true
        default: 'output/'
      branch:
        description: 'Mindustry branch (optional)'
        required: false
        default: 'master'

env:
  # 给 push 事件用的缺省值
  INPUT_FOLDER:  ${{ github.event.inputs.input_folder  || 'Mindustry/core/src/mindustry/' }}
  OUTPUT_FOLDER: ${{ github.event.inputs.output_folder || 'output/' }}
  BRANCH:        ${{ github.event.inputs.branch        || 'master' }}

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout self repo
        uses: actions/checkout@v4

      - name: Checkout Mindustry source
        uses: actions/checkout@v4
        with:
          repository: Anuken/Mindustry
          ref: ${{ github.event.inputs.branch }}
          path: Mindustry

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build converter
        run: mvn -B clean package

      - name: Run Java converter
        run: |
          java -jar target/java-to-excel-1.0-SNAPSHOT.jar \
            --input-folder  "$INPUT_FOLDER" \
            --output-root   "$OUTPUT_FOLDER"

      - name: Upload parsing logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parsing-logs
          path: parsing_errors.log

      - name: Zip entire output tree
        if: success()
        run: |
          zip -r java-fields-output.zip "$OUTPUT_FOLDER"

      - name: Upload output tree
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: java-fields-output
          path: java-fields-output.zip
